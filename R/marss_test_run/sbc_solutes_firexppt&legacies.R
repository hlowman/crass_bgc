# SB MARSS models for other solutes
# Script started August 26, 2022
# Heili Lowman, Alex Webster

#### READ ME ####

# The following script will prepare data and run MARSS analyses at SBC sites for the CRASS project.
# MARSS modeling sections each contain 1 model or 1 model comparision and restart the script and import data anew each time.
# Be sure to load libraries before starting modeling sections. 
# Much of this code has been copied over from the "sbc_vcnp_firexppt&legacies.R" script written by Alex, but removing any of the NM site processing/modeling.

#### Load packages - ***do this first for all sections!*** ####
library(tidyverse)
library(lubridate)
library(MARSS)
library(naniar) 
library(beepr)

# load fxn to replace NaNs with NAs
is.nan.data.frame <- function(x) do.call(cbind, lapply(x, is.nan))

#### Compile data ####

# Load datasets
# Stream Chemistry - all sites
# see script "sbc_chem_compilation.R" for the code used to tidy/generate this dataset
chem <- readRDS("data_working/SBchem_edited_120321.rds")

# Precipitation - all sites
precip <- readRDS("data_working/SBprecip_edited_120121.rds")

# Fire Events - all sites
fire <- readRDS("data_working/SBfire_edited_072922.rds")

# Site Location information
location <- read_csv("data_raw/sbc_sites_stream_hydro.csv")

# I first need to identify the matching stream sites for the precip data
precip_ed <- precip %>%
  mutate(sitecode_match = factor(case_when(
    sitecode == "GV202" ~ "GV01",
    sitecode == "BARA" ~ "HO00", # HO201 doesn't start until 2002
    sitecode == "RG202" ~ "RG01",
    sitecode == "SMPA" ~ "SP02",
    sitecode == "GORY" ~ "AT07",
    sitecode == "CAWTP" ~ "AB00",
    sitecode == "STFS" ~ "MC06", # BOGA doesn't start until 2005
    sitecode == "ELDE" ~ "RS02"))) %>%
  dplyr::rename(cumulative_precip_mm = c_precip_mm,
                sitecode_precip = sitecode) %>%
  mutate(Day = 1) %>% # new column of "days"
  mutate(Date = make_date(Year, Month, Day))

# check edited fire data
sitez = c("AB00", "GV01", "MC06", "RG01", "RS02", "HO00")

ggplot(fire %>% filter(site %in% sitez), 
       aes(x = date, y = fire_pa)) +
  geom_point() +
  labs(x = "Date") +
  facet_wrap(.~site, scales = "free",
             ncol = 1) +
  theme_bw()

ggplot(fire %>% filter(site %in% sitez), 
       aes(x = date, y = fire_perc_ws)) +
  geom_point() +
  labs(x = "Date") +
  facet_wrap(.~site, scales = "free",
             ncol = 1) +
  theme_bw()

## Timeframe Selection

# Examine precip data coverage for MARSS timescale delineation
precip_ed %>%
  drop_na(sitecode_match) %>%
  ggplot(aes(x = Year, y = sitecode_match, color = sitecode_match)) +
  geom_line() +
  theme_bw() +
  theme(legend.position = "none")

# So, covariate data, which cannot be missing, can run from a maximum of 9/2002 to 7/2016.

# To avoid strange gaps in data, I'm going to start with the fire data,
# since I know it extends from 9/1/2002 to 7/1/2016. This will ensure all other datasets are
# joined to these dates in full (which was causing problems earlier).
fire_precip <- left_join(fire, precip_ed, by = c("site" = "sitecode_match", "date" = "Date"))

fire_precip <- fire_precip %>%
  mutate(year = year(date),
         month = month(date)) # and the Year/Month didn't populate, so adding in new columns

# Then, left join with chemistry so as not to lose any data.
dat <- left_join(fire_precip, chem, by = c("site", "year" = "Year", "month" = "Month"))

# Adding in dummy covariates by season
n_months <- dat$date %>%
  unique() %>%
  length()

seas_1 <- sin(2 * pi * seq(n_months) / 12)
seas_2 <- cos(2 * pi * seq(n_months) / 12)

dat <- dat %>%
  mutate(Season1 = rep(seas_1, 8),
         Season2 = rep(seas_2, 8),
         index = rep(seq(1,166), 8))

# AJW: replace NaNs with NAs
dat[is.nan(dat)] = NA

# And, inspect dataset for missing covariate data.
sum(is.na(dat$fire)) # 0
sum(is.na(dat$cumulative_precip_mm)) # 0
# Great!

# Trim down to columns of interest
dat_select <- dat %>%
  select(year, month, index, site, ws_area_m2,
         cumulative_precip_mm, 
         fire_ID, ig_date, fire_pa, ws_fire_area_m2, fire_perc_ws,
         mean_nh4_uM, mean_no3_uM, mean_po4_uM, 
         Season1, Season2) %>%
  mutate(region = "SB")

# And export to save progress
saveRDS(dat_select, "data_working/marss_data_sb_N_P_082622.rds")

#### Import compiled data and add fire x ppt interactions and legacy effects ####

dat1 <- readRDS("data_working/marss_data_sb_N_P_082622.rds")

# reorganize
names(dat1)
dat2 = dat1[,c(1,2,3,17,4,5, #"year" "month" "index" "region" "site" "ws_area_m2"
               6, # cumulative_precip_mm
               7:11, # fire info
               15,16, # seasonal effects
               12:14)] # solutes

qplot(index, fire_pa, data=dat2, colour=site, geom="path", facets = "region")

# create df of sites x fire info
firez = unique(dat1[,c(4,7,8,10,11)])
firez = firez[complete.cases(firez),] # removes NAs
firez$ig_date = gsub("/","-",firez$ig_date) # reformat date
firez$year = year(as.Date(firez$ig_date)) # create year column
firez$month = month(as.Date(firez$ig_date)) # create month column
firez$date = as.Date(paste(firez$year, firez$month, "01", sep="-")) # reformat date again

#### Add 6 m window to fire effect ####

# fire_pa_6m: 1=fire ignited in prior 6 m, 0=no fire ignitions in 6 m
# creating 6 months of dates
firedates_6m = c(firez$date,
                 firez$date + 31*1,
                 firez$date + 31*2,
                 firez$date + 31*3,
                 firez$date + 31*4,
                 firez$date + 31*5)

# creating dataset with fire data repeated for 6 months
firedates_6m = data.frame(year = year(firedates_6m),
                          month = month(firedates_6m),
                          site = rep(firez$site, 6),
                          fire_pa_6m = 1,
                          ws_fire_area_m2_6m = rep(firez$ws_fire_area_m2, 6),
                          fire_perc_ws_6m = rep(firez$fire_perc_ws, 6))

# join with original data
dat3 = left_join(dat2, firedates_6m, by=c("year","month","site"))

# remove NAs to be zeros in fire info columns so they can be used as covariates
dat3[,18:20][is.na(dat3[,18:20])] = 0

qplot(index, fire_pa_6m, data=dat3, colour=site, geom="path", facets = "region")
qplot(index, fire_perc_ws_6m, data=dat3, colour=site, geom="point", facets = "region")

# And export to save progress
saveRDS(dat3, "data_working/marss_data_sb_N_P_6mon_082622.rds")

#### Add fire 6 m window legacy effects ####

# Waiting for Alex's code re: persistent legacy effects

#### Add fire x ppt legacy effects ####

# for fire pa
dat3$fire_pa_6m_ppt = dat3$fire_pa_6m*dat3$cumulative_precip_mm

# for fire area
dat3$ws_fire_area_m2_6m_ppt = dat3$ws_fire_area_m2_6m*dat3$cumulative_precip_mm

# for fire perc burn ws
dat3$fire_perc_ws_6m_ppt = dat3$fire_perc_ws_6m*dat3$cumulative_precip_mm

#### Add fire 2 m window legacy effects ####

# Also skipping for now.

#### Examine data closely ####

# precip
ggplot(dat3, aes(x = index, y = cumulative_precip_mm, color = site)) +
  geom_point() +
  facet_wrap(.~site) +
  theme(legend.position = "none")

# NH4 (0-60 uM)
ggplot(dat3, aes(x = index, y = mean_nh4_uM, color = site)) +
  geom_point() +
  facet_wrap(.~site) +
  theme(legend.position = "none")

# NO3 (0-600 uM)
ggplot(dat3, aes(x = index, y = mean_no3_uM, color = site)) +
  geom_point() +
  facet_wrap(.~site) +
  theme(legend.position = "none")

# PO4 (0-15 uM)
ggplot(dat3, aes(x = index, y = mean_po4_uM, color = site)) +
  geom_point() +
  facet_wrap(.~site) +
  theme(legend.position = "none")

#### Remove outliers ####

# Keeping all data points for now.

#### Export data ready for modeling ####

saveRDS(dat3, "data_working/marss_data_sb_082622.rds")

#### Plot data ready for modeling ####

# remove data
rm(list=ls())

# load fxn to replace NaNs with NAs
is.nan.data.frame <- function(x) do.call(cbind, lapply(x, is.nan))
is.infinite.data.frame <- function(x) do.call(cbind, lapply(x, is.infinite))

# load data with fire x ppt interactions
dat <- readRDS("data_working/marss_data_sb_082622.rds")

# add date
dat$date = as.Date(paste(dat$year, dat$month, "01", sep="-"))

# examine data to determine which sites to use for modeling

# NH4 in all sites
ggplot(dat, aes(x = date, y = mean_nh4_uM)) +
  geom_point() +
  geom_line() +
  labs(x = "Date")+
  facet_wrap(region~site, scales = "free") +
  theme_bw()+
  geom_vline(data=filter(dat, site=="AB00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="AT07" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="GV01" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="HO00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="MC06" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="RG01" & fire_pa==1), aes(xintercept=date),
             colour="red")+
  geom_vline(data=filter(dat, site=="RS02" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="SP02" & fire_pa==1), aes(xintercept=date), 
             colour="red")

# NO3 in all sites
ggplot(dat, aes(x = date, y = mean_no3_uM)) +
  geom_point() +
  geom_line() +
  labs(x = "Date")+
  facet_wrap(region~site, scales = "free") +
  theme_bw()+
  geom_vline(data=filter(dat, site=="AB00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="AT07" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="GV01" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="HO00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="MC06" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="RG01" & fire_pa==1), aes(xintercept=date),
             colour="red")+
  geom_vline(data=filter(dat, site=="RS02" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="SP02" & fire_pa==1), aes(xintercept=date), 
             colour="red")

# PO4 in all sites
ggplot(dat, aes(x = date, y = mean_po4_uM)) +
  geom_point() +
  geom_line() +
  labs(x = "Date")+
  facet_wrap(region~site, scales = "free") +
  theme_bw()+
  geom_vline(data=filter(dat, site=="AB00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="AT07" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="GV01" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="HO00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="MC06" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="RG01" & fire_pa==1), aes(xintercept=date),
             colour="red")+
  geom_vline(data=filter(dat, site=="RS02" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="SP02" & fire_pa==1), aes(xintercept=date), 
             colour="red")

# select sites for modeling
# these have the longest most complete ts for NH4/NO3/PO4 and have coverage before and after fires): 

# RG01 has a fire on the last data point
# SP02 has only 6 pre-fire data points

# AB00, AT07, GV01, HO00, MC06, RS02
sitez = c("AB00", "AT07", "GV01", "HO00", "MC06", "RS02")
dat = dat[dat$site %in% sitez,]

# Export data for later.
saveRDS(dat, "data_working/marss_data_sb_6sites_082622.rds")

# Examine remaining covariates with the filtered dataset

# Fire area in all sites - check to be sure lines up with fire dates
ggplot(dat, aes(x = date, y = ws_fire_area_m2)) +
  geom_point() +
  geom_line() +
  labs(x = "Date")+
  facet_wrap(region~site, scales = "free") +
  theme_bw()+
  geom_vline(data=filter(dat, site=="AB00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="AT07" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="GV01" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="HO00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="MC06" & fire_pa==1), aes(xintercept=date),
             colour="red")+
  # geom_vline(data=filter(dat, site=="RG01" & fire_pa==1), aes(xintercept=date), 
  #            colour="red")+
  geom_vline(data=filter(dat, site=="RS02" & fire_pa==1), aes(xintercept=date), 
             colour="red")
  # geom_vline(data=filter(dat, site=="SP02" & fire_pa==1), aes(xintercept=date), 
  #            colour="red")

# Fire % of watershed burned in all sites - check to be sure lines up with fire dates
ggplot(dat, aes(x = date, y = fire_perc_ws)) +
  geom_point() +
  geom_line() +
  labs(x = "Date")+
  facet_wrap(region~site, scales = "free") +
  theme_bw()+
  geom_vline(data=filter(dat, site=="AB00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="AT07" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="GV01" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="HO00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="MC06" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  # geom_vline(data=filter(dat, site=="RG01" & fire_pa==1), aes(xintercept=date), 
  #            colour="red")+
  geom_vline(data=filter(dat, site=="RS02" & fire_pa==1), aes(xintercept=date), 
             colour="red")
  # geom_vline(data=filter(dat, site=="SP02" & fire_pa==1), aes(xintercept=date), 
  #            colour="red")+

# ppt in all sites - check for outliers
ggplot(dat, aes(x = date, y = cumulative_precip_mm)) +
  geom_point() +
  geom_line() +
  labs(x = "Date")+
  facet_wrap(region~site, scales = "free") +
  theme_bw()+
  geom_vline(data=filter(dat, site=="AB00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="AT07" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="GV01" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="HO00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="MC06" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  # geom_vline(data=filter(dat, site=="RG01" & fire_pa==1), aes(xintercept=date), 
  #            colour="red")+
  geom_vline(data=filter(dat, site=="RS02" & fire_pa==1), aes(xintercept=date), 
             colour="red")
  # geom_vline(data=filter(dat, site=="SP02" & fire_pa==1), aes(xintercept=date), 
  #            colour="red")+

# Fire p/a X ppt in all sites - check if ppt interacts w/ fire in 6 mo timeframe
ggplot(dat, aes(x = date, y = fire_pa_6m_ppt)) +
  geom_point() +
  geom_line() +
  labs(x = "Date")+
  facet_wrap(region~site, scales = "free") +
  theme_bw()+
  geom_vline(data=filter(dat, site=="AB00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="AT07" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="GV01" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="HO00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="MC06" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  # geom_vline(data=filter(dat, site=="RG01" & fire_pa==1), aes(xintercept=date), 
  #            colour="red")+
  geom_vline(data=filter(dat, site=="RS02" & fire_pa==1), aes(xintercept=date), 
             colour="red")
  # geom_vline(data=filter(dat, site=="SP02" & fire_pa==1), aes(xintercept=date), 
  #            colour="red")+

# Fire area X ppt in all sites - again check for interaction with precip
ggplot(dat, aes(x = date, y = ws_fire_area_m2_6m_ppt)) +
  geom_point() +
  geom_line() +
  labs(x = "Date")+
  facet_wrap(region~site, scales = "free") +
  theme_bw()+
  geom_vline(data=filter(dat, site=="AB00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="AT07" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="GV01" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="HO00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="MC06" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  # geom_vline(data=filter(dat, site=="RG01" & fire_pa==1), aes(xintercept=date), 
  #            colour="red")+
  geom_vline(data=filter(dat, site=="RS02" & fire_pa==1), aes(xintercept=date), 
             colour="red")
  # geom_vline(data=filter(dat, site=="SP02" & fire_pa==1), aes(xintercept=date), 
  #            colour="red")+

# Fire % watershed burned X ppt in all sites - again check for interaction
ggplot(dat, aes(x = date, y = fire_perc_ws_6m_ppt)) +
  geom_point() +
  geom_line() +
  labs(x = "Date")+
  facet_wrap(region~site, scales = "free") +
  theme_bw()+
  geom_vline(data=filter(dat, site=="AB00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="AT07" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="GV01" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="HO00" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  geom_vline(data=filter(dat, site=="MC06" & fire_pa==1), aes(xintercept=date), 
             colour="red")+
  # geom_vline(data=filter(dat, site=="RG01" & fire_pa==1), aes(xintercept=date), 
  #            colour="red")+
  geom_vline(data=filter(dat, site=="RS02" & fire_pa==1), aes(xintercept=date), 
             colour="red")
  # geom_vline(data=filter(dat, site=="SP02" & fire_pa==1), aes(xintercept=date), 
  #            colour="red")+

#### MARSS NH4: ppt, % burn (2m win), % burn (6m win) x ppt, no legacy effects ####

# Set up data for MARSS

# remove data
rm(list=ls())

# load fxn to replace NaNs with NAs
is.nan.data.frame <- function(x) do.call(cbind, lapply(x, is.nan))
is.infinite.data.frame <- function(x) do.call(cbind, lapply(x, is.infinite))

# load data with fire x ppt interactions and legacy effects
dat = readRDS("data_working/marss_data_sb_082622.rds")

# select sites
# include these sites only (6 total - these have the longest most complete ts):
# AB00, AT07, GV01, HO00, MC06, RS02 = SB
sitez = c("AB00", "AT07", "GV01", "HO00", "MC06", "RS02")
dat = dat[dat$site %in% sitez,]
table(dat$site)
table(dat$site,dat$fire_pa)

# pivot wider for MARSS format
dat_nh4 <- dat %>%
  select(
    site, index, 
    mean_nh4_uM, 
    cumulative_precip_mm, 
    fire_pa, fire_pa_6m_ppt) %>% 
  pivot_wider(
    names_from = site, 
    values_from = c(mean_nh4_uM, cumulative_precip_mm, 
                    fire_pa, fire_pa_6m_ppt))

# indicate column #s of response and predictor vars
names(dat_nh4)
resp_cols = c(2:7)
cov_cols = c(8:25)

# log and scale transform response var
dat_nh4_log = dat_nh4
dat_nh4_log[,resp_cols] = log10(dat_nh4_log[,resp_cols])
dat_nh4_log[,resp_cols] = scale(dat_nh4_log[,resp_cols])

# check for NaNs (not allowed) and NAs (allowed in response but not predictors)
sum(is.nan(dat_nh4_log[,resp_cols])) # 0
sum(is.na(dat_nh4_log[,resp_cols])) # 264
range(dat_nh4_log[,resp_cols], na.rm = T)

# Pull out only response var
dat_dep <- t(dat_nh4_log[,c(resp_cols)])
row.names(dat_dep)

# check covars for nas, nans, or infs (none allowed)
sum(is.nan(dat_nh4_log[,cov_cols])) # 0
sum(is.na(dat_nh4_log[,cov_cols])) # 0
sum(is.infinite(dat_nh4_log[,cov_cols])) # 0

# Make covariate inputs
dat_cov <- dat_nh4_log[,c(cov_cols)]
# check for cols with all zeros
any(colSums(dat_cov)==0) # FALSE
# scale and transpose
dat_cov <- t(scale(dat_cov))
row.names(dat_cov)
# check for nas, nans, or infs
sum(is.nan(dat_cov)) # 0
sum(is.na(dat_cov)) # 0
sum(is.infinite(dat_cov)) # 0
# are any rows identical? this can cause model convergence issues
dat_cov[duplicated(dat_cov),]
# yes

#### Make C Matrix ####

# "XXXX_AB00",0,0,0,0,0,
# 0,"XXXX_AT07",0,0,0,0,
# 0,0,"XXXX_GV01",0,0,0,
# 0,0,0,"XXXX_HO00",0,0,
# 0,0,0,0,"XXXX_MC06",0,
# 0,0,0,0,0,"XXXX_RS02"

CC <- matrix(list( 
  # precip by site: cumulative_precip_mm
  "cumulative_precip_mm_AB00",0,0,0,0,0,
  0,"cumulative_precip_mm_AT07",0,0,0,0,
  0,0,"cumulative_precip_mm_GV01",0,0,0,
  0,0,0,"cumulative_precip_mm_HO00",0,0,
  0,0,0,0,"cumulative_precip_mm_MC06",0,
  0,0,0,0,0,"cumulative_precip_mm_RS02",
  # fire_pa: fire effect in 2 m window
  "fire_pa_AB00",0,0,0,0,0,
  0,"fire_pa_AT07",0,0,0,0,
  0,0,"fire_pa_GV01",0,0,0,
  0,0,0,"fire_pa_HO00",0,0,
  0,0,0,0,"fire_pa_MC06",0,
  0,0,0,0,0,"fire_pa_RS02",
  # fire_pa_6m_ppt: interaction of cum. ppt with fire p/a in 6 m window
  "fire_pa_6m_ppt_AB00",0,0,0,0,0,
  0,"fire_pa_6m_ppt_AT07",0,0,0,0,
  0,0,"fire_pa_6m_ppt_GV01",0,0,0,
  0,0,0,"fire_pa_6m_ppt_HO00",0,0,
  0,0,0,0,"fire_pa_6m_ppt_MC06",0,
  0,0,0,0,0,"fire_pa_6m_ppt_RS02"), 6,18)

#### Model setup for MARSS ####

mod_list <- list(
  ### inputs to process model ###
  B = "diagonal and unequal",
  U = "zero",
  C = CC, 
  c = dat_cov,
  Q = "diagonal and unequal", 
  ### inputs to observation model ###
  Z='identity', 
  A="zero",
  D="zero" ,
  d="zero",
  R = "zero", 
  ### initial conditions ###
  #x0 = matrix(x0_fixed),
  V0="zero" ,
  tinitx=0
)

#### Fit MARSS model ####

# fit BFGS with priors
kemfit <- MARSS(y = dat_dep, model = mod_list,
                control = list(maxit= 100, allow.degen=TRUE, trace=1, safe=TRUE), fit=TRUE)

fit <- MARSS(y = dat_dep, model = mod_list,
             control = list(maxit = 5000), method = "BFGS", inits=kemfit$par)

# export model fit
saveRDS(fit, 
        file = "data_working/marss_test_run/fit_08262022_6state_nh4_fire2mpa_fire6mpaxPPT_nolegacies_mBFGS.rds")

# End of script.
